<html>
<meta charset="utf-8" />
<head>
	<link rel="stylesheet" href="css/style.css">
	<script src="vgmplay-js.js"></script>
	<script src="vgmplay-js-glue.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/mousetrap/1.4.6/mousetrap.min.js"></script>
</head>
<body>

<section class="container">
	<div id="p" class="progress">
		<div id="pb" class="progress-bar"></div>
	</div>
	<br/>
	<button onclick="changeTrack(1)">|&lt;</button>
	<button id="buttonTogglePlayback" onclick="togglePlayback()">||</button>
	<button onclick="changeTrack()">&gt;|</button>
	<button onclick="togglePlayback(true)">&#9632;</button>
	<br/><br/>
	Loopcount: <input type=text id=loopCount value=2 size=5 style="text-align:center">
	<br/><br/>
        <div id="dnd-panel">Drag 'n drop your VGM file here!</div>

	
</section>
<button onclick="removeProgressTransitionClass()">go</button>
<script>

//var domain = "192.168.1.14";
var domain = "vlessert.nl";
var url = "http://"+domain+"/";

var track = 0;
var trackData;
var firstRun = true;
var tracks = ["01","03","10","54"];

var currentWidth;
var currentTransition;

setKeyBindings();

const vgmplay_webaudio = new VGMPlay_WebAudio();

changeTrack();

function removeProgressTransitionClass(){
	document.getElementById("pb").classList.remove("progress-bar");
}

function changeTrack(previous){
	if (!firstRun) {
		if (previous==1){
			if (track > 0) track--; else track = tracks.length-1;
		} else {
			if (track < tracks.length-1) track++; else track = 0;
		}
		vgmplay_webaudio.setLoopCount(document.getElementById("loopCount").value);
	}
	vgmplay_webaudio.loadURL(url+tracks[track]+'.vgm', true, setProgressBar, changeTrack);
}

function togglePlayback(fullStop) {
	if (!vgmplay_webaudio.isPaused) {
		document.getElementById("buttonTogglePlayback").innerHTML="&#9654;";
		//currentTransition = document.getElementById("pb").style.transition;
		//currentWidth = document.getElementById("pb").style.width;

		document.getElementById("pb").style.transition = "none";
		//document.getElementById("pb").style.width = "10%";
		//pause progressbar
	} else {
		document.getElementById("buttonTogglePlayback").innerHTML="||";
		//continue progressbar
	}
	vgmplay_webaudio.togglePause(fullStop);
}

// key bindings

function setKeyBindings() {
	window.addEventListener('keydown', function(e) {
		if(e.keyCode == 32) e.preventDefault();
	});

	Mousetrap.bind('space', function(e) {
		togglePlayback();
	});
	Mousetrap.bind('n', function(e) {
		changeTrack();
	});
	Mousetrap.bind('p', function(e) {
		changeTrack(1);
	});
}

// progress bar

function setProgressBar(){
	trackData = vgmplay_webaudio.getTrackInfo();
	console.log(trackData[0]);
	if (!firstRun) {
		document.getElementById("pb").style.transition = "0s linear";
		document.getElementById("pb").style.width = "0%";
	} else firstRun = false;

	setTimeout(function(){
		document.getElementById("pb").style.transition = trackData[0]+5+"s linear";
		document.getElementById("pb").style.width = "100%";
	}, 0);
}

var parentDiv = document.getElementById('p');

parentDiv.addEventListener('click', function (e) {
        var offset = this.getClientRects()[0];
        var destination = (e.clientX - offset.left)/4;
        document.getElementById("pb").style.transition = "0s linear";
        document.getElementById("pb").style.width = destination+"%";
	setTimeout(function(){
		var clicked = trackData[0]-(trackData[0]*(destination/100));
		document.getElementById("pb").style.width = "100%";
		document.getElementById("pb").style.transition = clicked+5+"s linear";
		console.log(destination/4 + " " + clicked)
		vgmplay_webaudio.seek(Math.floor(destination*(trackData[0]/100)));
	 }, 0);
}, false);

// drag 'n drop

function onDragEnter(e) {
	e.preventDefault();
	dndPanel.classList.add('ondrag');
}

function onDragLeave(e) {
	e.preventDefault();
	dndPanel.classList.remove('ondrag');
}

function onDragOver(e) { 
	e.preventDefault();
}

function onDrop(e) {
	e.preventDefault();
	dndPanel.classList.remove('ondrag');

	function createPlayerForFile(file) {
		var reader = new FileReader();
		reader.onloadend = function() {
			try {
				console.log("file loaded!!!");
			} catch(e) {
				console.log(e);
			}
		}
		reader.readAsArrayBuffer(file);
	}

	for(var i=0;i<e.dataTransfer.files.length;i++) {
		createPlayerForFile(e.dataTransfer.files[i]);
	}
}

window.addEventListener('DOMContentLoaded', function() {
	//.install(document.body);

	dndPanel = document.getElementById('dnd-panel');
	dndPanel.addEventListener("dragover", onDragOver);
	dndPanel.addEventListener("dragenter", onDragEnter);
	dndPanel.addEventListener("dragleave", onDragLeave);
	dndPanel.addEventListener("drop", onDrop);
});

// old/tests...

function displayStuff(){
	var test = vgmplay_webaudio.getTrackInfo();
	console.log("Track length: "+test[0]);
	console.log("Loop point: "+test[1]);
	console.log("Loop count: "+test[2]);
	console.log("Initial length: "+test[3]);
}

function readInMemory(){
	console.log("read!!");
        context = new AudioContext();
        destination = context.destination;

	vgmplay.play();

        var node = context.createBufferSource()
                , buffer = context.createBuffer(1, 16384000, context.sampleRate)
                , data = buffer.getChannelData(0);

        for (i=0;i<1000;i++){
		console.log(i);
                var result = new Int16Array();
                result = vgmplay.getAudioBuffer();
                for(var j = 0; j < 16384; j++) {
                        data[j+(i*16384)]=result[j]/32768;
                }
        }

        node.buffer = buffer;
        node.loop = true;
        node.connect(context.destination);
        node.start(0);
}

//const vgmplay = new VGMPlay();

function load() {
	console.log("load!!");
	vgmplay.loadURL("http://192.168.1.14/03.vgm");
	vgmplay.play();
}

/*<button onclick="load()">Load</button>
<button onclick="readInMemory()">Generate</button>*/

</script>

</body>

</html>
